<!-- Event Detail Page -->
{% extends "base.html" %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-lg-8">
            <!-- Event Header -->
            <div class="card border-0 shadow-lg mb-4">
                <div class="position-relative">
                    {% if event.image_filename %}
                        <img src="{{ url_for('static', filename='uploads/' + event.image_filename) }}" 
                             class="card-img-top" alt="{{ event.title }}" style="height: 400px; object-fit: cover;">
                    {% else %}
                        {% set category_img = 'images/event-default.svg' %}
                        {% if event.category == 'workshop' %}
                            {% set category_img = 'images/event-workshop.svg' %}
                        {% elif event.category == 'meetup' %}
                            {% set category_img = 'images/event-meetup.svg' %}
                        {% elif event.category == 'conference' %}
                            {% set category_img = 'images/event-conference.svg' %}
                        {% elif event.category == 'social' %}
                            {% set category_img = 'images/event-social.svg' %}
                        {% endif %}
                        <img src="{{ url_for('static', filename=category_img) }}" 
                             class="card-img-top" alt="{{ event.title }}" style="height: 400px; object-fit: cover;">
                    {% endif %}
                    <div class="position-absolute bottom-0 start-0 w-100 p-4" 
                         style="background: linear-gradient(transparent, rgba(0,0,0,0.8));">
                        <span class="badge bg-primary mb-2">{{ event.category|title }}</span>
                        <span class="badge bg-{{ 'success' if event.status == 'published' else 'warning' if event.status == 'draft' else 'danger' }} ms-2">
                            {{ event.status|title }}
                        </span>
                        <h1 class="card-title text-white mt-2">{{ event.title }}</h1>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex gap-2">
                            {% if event.is_registration_open and event.available_spots > 0 %}
                                {% if is_registered %}
                                    <form action="{{ url_for('events.unregister_from_event', event_id=event.id) }}" method="POST">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                        <button type="submit" class="btn btn-outline-danger"
                                                onclick="return confirm('Are you sure you want to unregister?')">
                                            <i class="fas fa-times me-1"></i>Unregister
                                        </button>
                                    </form>
                                {% else %}
                                    <form action="{{ url_for('events.register_for_event', event_id=event.id) }}" method="POST">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                        <button type="submit" class="btn btn-primary btn-lg"
                                                onclick="return confirm('Are you sure you want to register for this event?')">
                                            <i class="fas fa-ticket-alt me-1"></i>Register Now
                                        </button>
                                    </form>
                                {% endif %}
                            {% elif event.is_full %}
                                <button class="btn btn-secondary btn-lg" disabled>
                                    <i class="fas fa-times-circle me-1"></i>Event Full
                                </button>
                            {% elif not event.is_registration_open %}
                                <button class="btn btn-secondary btn-lg" disabled>
                                    <i class="fas fa-lock me-1"></i>Registration Closed
                                </button>
                            {% endif %}
                            
                            {% if current_user.is_authenticated and (event.creator_id == current_user.id or current_user.is_admin()) %}
                                <a href="{{ url_for('events.edit_event', event_id=event.id) }}" class="btn btn-outline-primary btn-lg">
                                    <i class="fas fa-edit me-1"></i>Edit
                                </a>
                                {% if current_user.is_admin() or event.creator_id == current_user.id %}
                                    <form action="{{ url_for('events.delete_event', event_id=event.id) }}" method="POST" class="d-inline">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                        <button type="submit" class="btn btn-outline-danger btn-lg"
                                                onclick="return confirm('Are you sure you want to delete this event? This action cannot be undone.')">
                                            <i class="fas fa-trash me-1"></i>Delete
                                        </button>
                                    </form>
                                {% endif %}
                            {% endif %}
                        </div>
                        
                        <!-- Share Buttons -->
                        <div class="share-buttons">
                            <span class="text-muted me-2">Share:</span>
                            <a href="#" class="btn btn-sm btn-outline-primary" title="Share on Facebook">
                                <i class="fab fa-facebook-f"></i>
                            </a>
                            <a href="#" class="btn btn-sm btn-outline-info" title="Share on Twitter">
                                <i class="fab fa-twitter"></i>
                            </a>
                            <a href="#" class="btn btn-sm btn-outline-success" title="Share on WhatsApp">
                                <i class="fab fa-whatsapp"></i>
                            </a>
                        </div>
                    </div>

                    <!-- Event Description -->
                    <h4 class="mb-3">About This Event</h4>
                    <p class="card-text">{{ event.description }}</p>
                </div>
            </div>

            <!-- Event Details Card -->
            <div class="card border-0 shadow mb-4">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Event Details</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <div class="bg-primary bg-gradient rounded-3 p-3 me-3">
                                    <i class="fas fa-calendar-alt fa-2x text-white"></i>
                                </div>
                                <div>
                                    <label class="text-muted small mb-0">Date & Time</label>
                                    <p class="fw-medium mb-0">{{ event.event_date.strftime('%A, %B %d, %Y') }}</p>
                                    <small class="text-muted">{{ event.event_date.strftime('%I:%M %p') }}</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <div class="bg-success bg-gradient rounded-3 p-3 me-3">
                                    <i class="fas fa-map-marker-alt fa-2x text-white"></i>
                                </div>
                                <div>
                                    <label class="text-muted small mb-0">Location</label>
                                    <p class="fw-medium mb-0">{{ event.location }}</p>
                                    <small class="text-muted">View on map</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <div class="bg-info bg-gradient rounded-3 p-3 me-3">
                                    <i class="fas fa-users fa-2x text-white"></i>
                                </div>
                                <div>
                                    <label class="text-muted small mb-0">Capacity</label>
                                    <p class="fw-medium mb-0">{{ registration_count }} / {{ event.capacity }} attendees</p>
                                    {% if event.available_spots > 0 %}
                                        <small class="text-success">{{ event.available_spots }} spots available</small>
                                    {% else %}
                                        <small class="text-danger">Event is full</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <div class="bg-warning bg-gradient rounded-3 p-3 me-3">
                                    <i class="fas fa-clock fa-2x text-white"></i>
                                </div>
                                <div>
                                    <label class="text-muted small mb-0">Registration Deadline</label>
                                    {% if event.registration_deadline %}
                                        <p class="fw-medium mb-0">{{ event.registration_deadline.strftime('%B %d, %Y') }}</p>
                                        <small class="text-muted">{{ event.registration_deadline.strftime('%I:%M %p') }}</small>
                                    {% else %}
                                        <p class="fw-medium mb-0">No deadline</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Capacity Progress -->
            <div class="card border-0 shadow mb-4">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Registration Progress</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span>{{ registration_count }} registered</span>
                            <span>{{ event.capacity - registration_count }} spots left</span>
                        </div>
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar bg-primary progress-bar-striped" 
                                 role="progressbar" 
                                 data-width="{{ (registration_count / event.capacity * 100)|round|int }}%"
                                 style="width: 0%;">
                                {{ (registration_count / event.capacity * 100)|round|int }}%
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Organizer Info -->
            <div class="card border-0 shadow mb-4">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0"><i class="fas fa-user me-2"></i>Event Organizer</h5>
                </div>
                <div class="card-body text-center">
                    <div class="bg-primary bg-gradient rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" 
                         style="width: 80px; height: 80px;">
                        <i class="fas fa-user fa-3x text-white"></i>
                    </div>
                    <h5>{{ event.creator.username }}</h5>
                    <p class="text-muted small mb-3">{{ event.creator.email }}</p>
                    <a href="{{ url_for('main.profile', username=event.creator.username) }}" 
                       class="btn btn-outline-primary btn-sm">
                        View Profile
                    </a>
                </div>
            </div>

            <!-- Registration Status -->
            <div class="card border-0 shadow mb-4 {% if is_registered %}bg-success text-white{% endif %}">
                <div class="card-body text-center">
                    {% if is_registered %}
                        <i class="fas fa-check-circle fa-4x mb-3"></i>
                        <h4>You're Registered!</h4>
                        <p>You have successfully registered for this event.</p>
                    {% elif event.is_full %}
                        <i class="fas fa-times-circle fa-4x text-danger mb-3"></i>
                        <h4>Event Full</h4>
                        <p>Unfortunately, this event has reached its capacity.</p>
                    {% elif event.is_registration_open %}
                        <i class="fas fa-ticket-alt fa-4x text-primary mb-3"></i>
                        <h4>Register Now!</h4>
                        <p>Don't miss out! Only {{ event.available_spots }} spots left.</p>
                        <form action="{{ url_for('events.register_for_event', event_id=event.id) }}" method="POST">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <button type="submit" class="btn btn-primary w-100"
                                    onclick="return confirm('Are you sure you want to register for this event?')">
                                <i class="fas fa-check me-1"></i>Confirm Registration
                            </button>
                        </form>
                    {% else %}
                        <i class="fas fa-lock fa-4x text-muted mb-3"></i>
                        <h4>Registration Closed</h4>
                        <p>Registration for this event is no longer available.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Similar Events -->
            <div class="card border-0 shadow">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0"><i class="fas fa-calendar me-2"></i>Similar Events</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted text-center">More events in this category coming soon!</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Set progress bar widths dynamically
    document.querySelectorAll('.progress-bar').forEach(bar => {
        const width = bar.getAttribute('data-width');
        if (width) {
            bar.style.width = width;
        }
    });
</script>
{% endblock %}
